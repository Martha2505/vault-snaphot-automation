name: Vault Hourly Snapshot to Azure

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:      # Allow manual trigger too

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Take Vault snapshot and upload to Azure
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_CONTAINER_NAME: ${{ secrets.AZURE_CONTAINER_NAME }}
          AZURE_SAS_TOKEN: ${{ secrets.AZURE_SAS_TOKEN }}
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          SNAPSHOT_NAME="vault-snapshot-$TIMESTAMP.snap"

          curl \
            --header "X-Vault-Token: $VAULT_TOKEN" \
            --request GET \
            --output $SNAPSHOT_NAME \
            $VAULT_ADDR/v1/sys/storage/raft/snapshot

          echo "Uploading to Azure Blob Storage..."
          curl -X PUT -T "$SNAPSHOT_NAME" \
            "https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_CONTAINER_NAME}/$SNAPSHOT_NAME${AZURE_SAS_TOKEN}"
