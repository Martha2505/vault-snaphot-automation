name: Vault Snapshot Upload

on:
  workflow_dispatch:

jobs:
  upload-snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v3

      - name: Set timestamp
        id: timestamp
        run: echo "value=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: Download Vault snapshot
        run: |
          curl --header "X-Vault-Token: ${{ secrets.VAULT_TOKEN }}" \
               https://vault-cluster-http-vault-8348053f.j.cloud.hashicorp.com//v1/sys/storage/raft/snapshot \
               --output snapshot.snap

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Upload to Blob with Azure CLI
        run: |
          az storage blob upload \
            --account-name mystorageaccount \
            --container-name vault-snapshots \
            --name snapshot-${{ steps.timestamp.outputs.value }}.snap \
            --file snapshot.snap \
            --auth-mode login
